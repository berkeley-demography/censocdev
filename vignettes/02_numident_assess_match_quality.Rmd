---
title: "Assessing Match Quality"
author: "Casey Breen" 
---

Summary: Assessing match quality in the 1940 census. 

```{r}
## Library packages 
library(tidyverse)
library(data.table)
library(censocdev)
library(cowplot)
library(gt)

## library here 
library(here)
```


```{r}
## read in numident 
numident <- fread("/censoc/data/censoc_v2/censoc_numident_v2.csv") %>% 
  janitor::clean_names()

## read in 1940 census 
census_1940 <- fread("/ipums-repo2019/1940/TSV/P.tsv", select = c("HISTID", "SERIALP", "AGE", "INCWAGE", "SEX", "EDUC", "RACE", "RELATE")) %>% 
  janitor::clean_names()

## read in 1940 census household 
census_1940_h <- fread("/ipums-repo2019/1940/TSV/H.tsv", select = c("SERIAL", "STATEFIP", "OWNERSHP", "URBAN")) %>% 
  janitor::clean_names()
```

```{r}
## combine census 
census_1940_hh_vars <- census_1940 %>% 
  inner_join(census_1940_h, by = c("serialp" = "serial"))

## add on numident  
census_1940_hh_vars <- census_1940_hh_vars %>% 
  left_join(numident, by = "histid")

## drop sex 
census_1940_hh_vars <- census_1940_hh_vars %>% 
  filter(sex.x == 1)

## recode 
census_1940_hh_vars <- census_1940_hh_vars %>% 
  censocdev::recode_education(educ_var = educ)
```

## Calculate match rate 

```{r}
## create variable indicating whether someone has been matched 
census_1940_hh_vars <- census_1940_hh_vars %>% 
  mutate(match_conservative = case_when(
    link_abe_exact_conservative == 1 ~ "Matched",
    TRUE ~ "Unmatched"
  )) %>% 
  mutate(match_standard = case_when(
    link_abe_exact_conservative %in% c(0, 1) ~ "Matched",
    TRUE ~ "Unmatched"
  ))
```

```{r}
## numident match rate (standard)
match_rate <- census_1940_hh_vars %>% 
  group_by(age) %>% 
  summarize(match_rate = round(mean(match_standard == "Matched"), 3)) %>% 
  mutate(match_type = "standard")

## numident match rate (conservative)
match_rate_conservative <- census_1940_hh_vars %>% 
  group_by(age) %>% 
  summarize(match_rate = round(mean(match_conservative == "Matched"), 3)) %>% 
  mutate(match_type = "conservative")

## plot numident match rate 
numident_match_rate <- match_rate %>% 
  bind_rows(match_rate_conservative) %>% 
  ggplot(aes(x = age, y = match_rate, color = match_type)) + 
  geom_line() + 
  geom_point() + 
  theme_cowplot() + 
  ggsci::scale_color_lancet() + 
  labs(x = "Age",
       y = "Match Rate") + 
  xlim(0, 100) + 
  theme(legend.position = "bottom", legend.title = element_blank()) 

## save plot 
ggsave(numident_match_rate, filename = here("vignettes/assess_match_quality/figs/numident_raw_match_rate.pdf"), height = 7, width = 10)
```

## Comparison of Socioeconomic Status 

```{r}
## recode variables 
census_1940_hh_vars <- census_1940_hh_vars %>% 
  mutate(hs = case_when(
    educ >= 60 & educ < 998 ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(rural = case_when(
    urban == 1 ~ 1,
    TRUE ~ 0
  ))  %>% 
  mutate(black = case_when( 
    race == 200 ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(white = case_when(
    race == 100 ~ 1,
    TRUE ~ 0
  )) %>% 
  mutate(homeown = case_when(
    ownershp == 10 ~ 1, 
    TRUE ~ 0
  )) %>% 
  mutate(p_hh_head = case_when(
    relate == 101 ~ 1, 
    TRUE ~ 0
  ))

## Calculate sample proportion (standard)
matched_characteristics_standard <- census_1940_hh_vars %>% 
  group_by(age, match_standard) %>%
  summarize(p_hs = mean(hs),
            p_rural = mean(rural),
            p_black = mean(black),
            p_white = mean(white),
            p_homeown = mean(homeown),
            p_household_head = mean(p_hh_head)) %>% 
  pivot_longer(cols = starts_with("p_"), names_to = "type",
               names_prefix = "p_", values_to = "prop")

## Calculate sample proportion (conservative)
matched_characteristics_conservative <- census_1940_hh_vars %>% 
  group_by(age, match_conservative) %>%
  summarize(p_hs = mean(hs),
            p_rural = mean(rural),
            p_black = mean(black),
            p_white = mean(white),
            p_homeown = mean(homeown),
            p_household_head = mean(p_hh_head)) %>% 
  pivot_longer(cols = starts_with("p_"), names_to = "type",
               names_prefix = "p_", values_to = "prop")

## Reshape data (standard)
matched_characteristics_standard <- matched_characteristics_standard %>% 
  mutate(type = as.factor(case_when(
    type == "hs" ~ "Educ: High School",
    type == "rural" ~ "Rural",
    type == "black" ~ "Race: Black",
    type == "white" ~ "Race: White",
    type == "household_head" ~ "Houshold Head",
    type == "homeown" ~ "Home Owner"
  ))) %>% 
  mutate(type = factor(type, levels=c('Educ: High School',
                                      'Race: Black','Race: White', 'Rural',
                                      "Houshold Head", "Home Owner")))


## Reshape data (conservative)
matched_characteristics_conservative <- matched_characteristics_conservative %>% 
  mutate(type = as.factor(case_when(
    type == "hs" ~ "Educ: High School",
    type == "rural" ~ "Rural",
    type == "black" ~ "Race: Black",
    type == "white" ~ "Race: White",
    type == "household_head" ~ "Houshold Head",
    type == "homeown" ~ "Home Owner"
  ))) %>% 
  mutate(type = factor(type, levels=c('Educ: High School',
                                      'Race: Black','Race: White', 'Rural',
                                      "Houshold Head", "Home Owner")))


## Plot data —— numident representativeness (standard)
matched_characteristics_plot_standard <- matched_characteristics_standard %>% 
   ggplot(aes(x = age, y = prop, color = as.factor(match_standard))) + 
  geom_line(size = 1) + 
  theme_cowplot() + 
  ggsci::scale_color_lancet() + 
  xlim(20, 50) + 
  theme(legend.position = "bottom", legend.title = element_blank()) + 
  facet_wrap(~type) + 
    background_grid() 

## Plot data —— numident representativeness (conservative)
matched_characteristics_plot_conservative <- matched_characteristics_conservative %>% 
   ggplot(aes(x = age, y = prop, color = as.factor(match_conservative))) + 
  geom_line(size = 1) + 
  theme_cowplot() + 
  ggsci::scale_color_lancet() + 
  xlim(20, 50) + 
  theme(legend.position = "bottom", legend.title = element_blank()) + 
  facet_wrap(~type) + 
  background_grid() 


## save plot 
ggsave(matched_characteristics_plot_standard, filename = here("vignettes/assess_match_quality/figs/numident_matched_characteristics_plot_standard.pdf"), height = 7, width = 10)

## save plot 
ggsave(matched_characteristics_plot_conservative, filename = here("vignettes/assess_match_quality/figs/numident_matched_characteristics_plot_conservative.pdf"), height = 7, width = 10)
```

## Sample Characteristics Table 

```{r}
## 1940 census 
census_1940_characteristics <- census_1940_hh_vars %>% 
  filter(age %in% 15:40) %>% 
  summarize(p_educ_years = mean(educ_yrs, na.rm = T), p_black = mean(black), p_rural = mean(rural), p_homeowner = mean(homeown), p_highschool = mean(hs), p_household_head = mean(p_hh_head), p_white = mean(white), p_observations = n()) %>% 
pivot_longer(cols = starts_with("p_"), names_to = "type",
               names_prefix = "p_", values_to = "prop")

## matched census characteristics 
numident_1940_characteristics_standard <- census_1940_hh_vars %>% 
  filter(age %in% 15:40) %>% 
  filter(match_standard == "Matched") %>%  
  summarize(p_educ_years = mean(educ_yrs, na.rm = T), p_black = mean(black), p_rural = mean(rural), p_homeowner = mean(homeown), p_highschool = mean(hs), p_household_head = mean(p_hh_head), p_white = mean(white), p_observations = n()) %>% 
pivot_longer(cols = starts_with("p_"), names_to = "type",
               names_prefix = "p_", values_to = "prop")

## matched census characteristics 
numident_1940_characteristics_conservative <- census_1940_hh_vars %>% 
  filter(age %in% 15:40) %>% 
  filter(match_conservative == "Matched") %>%  
  summarize(p_educ_years = mean(educ_yrs, na.rm = T), p_black = mean(black), p_rural = mean(rural), p_homeowner = mean(homeown), p_highschool = mean(hs), p_household_head = mean(p_hh_head), p_white = mean(white), p_observations = n()) %>% 
pivot_longer(cols = starts_with("p_"), names_to = "type",
               names_prefix = "p_", values_to = "prop")

## inner join 
numident_characteristics_table <- inner_join(census_1940_characteristics, numident_1940_characteristics_standard, by = "type") %>%
  inner_join(numident_1940_characteristics_conservative, by = "type") %>% 
  mutate(prop.x = round(prop.x, 3),
         prop.y = round(prop.y, 3),
         prop = round(prop, 3)) %>% 
  dplyr::select(type, Census = prop.x, CenSoc_numident = prop.y, CenSoc_numident_conservative = prop) %>% 
  gt() 

## print 
numident_characteristics_table %>% 
  as_latex() %>%
  as.character() %>%
  cat()

## save table 
numident_characteristics_table %>%
  gtsave("numident_characteristics.tex", path = here("vignettes/assess_match_quality/figs/")) 
```
