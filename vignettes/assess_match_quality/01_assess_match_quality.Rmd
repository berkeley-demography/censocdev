---
title: "Assessing Match Quality"
author: "Casey Breen" 
---

Summary: Assessing match quality in the 1940 census. 

```{r}
## Library packages 
library(tidyverse)
library(data.table)
library(censocdev)
library(cowplot)
library(gt)
library(ipumsr)
library(here)
```


```{r}
## read in dmf 
dmf <- fread("/censoc/data/censoc_v2/censoc_dmf_v2.csv") %>% 
  janitor::clean_names()

## read in 1940 census 
census_1940 <- fread("/ipums-repo2019/1940/TSV/P.tsv", select = c("HISTID", "SERIALP", "AGE", "INCWAGE", "SEX", "EDUC", "RACE", "RELATE", "REGION", "MARST", "SEI")) %>% 
  janitor::clean_names()

## read in 1940 census household
census_1940_h <- fread("/ipums-repo2019/1940/TSV/H.tsv", select = c("SERIAL", "STATEFIP", "OWNERSHP", "URBAN", "REGION")) %>% 
  janitor::clean_names()

```

```{r}
## combine census 
census_1940_hh_vars <- census_1940 %>% 
  inner_join(census_1940_h, by = c("serialp" = "serial"))

## add on dmf  
census_1940_hh_vars <- census_1940_hh_vars %>% 
  left_join(dmf, by = "histid")

## drop sex 
census_1940_hh_vars <- census_1940_hh_vars %>% 
  filter(sex == 1)

## recode 
census_1940_hh_vars <- census_1940_hh_vars %>% 
  censocdev::recode_education(educ_var = educ)

## data dictionary initiative
ipums_ddi <- ipumsr::read_ipums_ddi("/ipums-repo2019-1/fullcount.ddi.xml")

census_1940_hh_vars <- census_1940_hh_vars %>% 
  janitor::clean_names(case = "all_caps") %>% 
  ipumsr::ipums_collect(ipums_ddi, var_attrs = c("val_labels", "var_label", "var_desc")) %>% 
    janitor::clean_names()
```

## Calculate match rate 

```{r}
## create variable indicating whether someone has been matched 
census_1940_hh_vars <- census_1940_hh_vars %>% 
  mutate(match_conservative = case_when(
    link_abe_exact_conservative == 1 ~ "Matched",
    TRUE ~ "Unmatched"
  ), match_standard = case_when(
    link_abe_exact_conservative %in% c(0, 1) ~ "Matched",
    TRUE ~ "Ummatched"
  ))

## recode variables 
census_1940_hh_vars <- census_1940_hh_vars %>% 
  mutate(hs = case_when(
    educ >= 60 & educ < 998 ~ 1,
    TRUE ~ 0
  ), 
  rural = case_when(
    urban == 1 ~ 1,
    TRUE ~ 0
  ),
  black = case_when( 
    race == 200 ~ 1,
    TRUE ~ 0
  ), white = case_when(
    race == 100 ~ 1,
    TRUE ~ 0
  ),
  homeown = case_when(
    ownershp == 10 ~ 1, 
    TRUE ~ 0
  ),
  p_hh_head = case_when(
    relate == 101 ~ 1, 
    TRUE ~ 0
  ),
  p_hh_head = case_when(
    relate == 101 ~ 1, 
    TRUE ~ 0
  )) 
  

census_1940_hh_vars <- census_1940_hh_vars %>% 
  mutate(educ_level = case_when(
    educ <= 50 ~ "< High School",
    educ %in% 60:90 ~ "High School or some college",
    educ %in% 100 ~ "Bachelors Degree",
    educ %in% 110:116 ~ "Advanced Degree"
  ), sei_recode = case_when(
    sei %in% 1:9 ~ "sei_1_9",
    sei %in% 10:14 ~ "sei_10_14",
    sei %in% 15:25 ~ "sei_15_25",
    sei >= 26 ~      "sei_26+"
  ), marital_status = case_when(
      marst %in% 1:2 ~ "married",
      TRUE ~ "not married" ),
  region_string = as_factor(region),
  race_recode = case_when(
    race == 100 ~ "White",
    race == 200 ~ "Black",
    TRUE ~ "Other"
  ))
  
  
  
```

```{r}
## dmf match rate (standard)
match_rate <- census_1940_hh_vars %>% 
  group_by(age) %>% 
  summarize(match_rate = round(mean(match_standard == "Matched"), 3)) %>% 
  mutate(match_type = "standard")

## dmf match rate (conservative)
match_rate_conservative <- census_1940_hh_vars %>% 
  group_by(age) %>% 
  summarize(match_rate = round(mean(match_conservative == "Matched"), 3)) %>% 
  mutate(match_type = "conservative")

## plot dmf match rate 
dmf_match_rate <- match_rate %>% 
  bind_rows(match_rate_conservative) %>% 
  ggplot(aes(x = age, y = match_rate, color = match_type)) + 
  geom_line() + 
  geom_point() + 
  theme_cowplot() + 
  ggsci::scale_color_lancet() + 
  labs(x = "Age",
       y = "Match Rate") + 
  xlim(0, 100) + 
  theme(legend.position = "bottom", legend.title = element_blank()) 

## save plot 
ggsave(dmf_match_rate, filename = here("vignettes/assess_match_quality/figs/dmf_raw_match_rate.pdf"), height = 7, width = 10)
```

## Comparison of Socioeconomic Status 

```{r}
## Calculate sample proportion (standard)
matched_characteristics_standard <- census_1940_hh_vars %>% 
  group_by(age, match_standard) %>%
  summarize(p_hs = mean(hs),
            p_rural = mean(rural),
            p_black = mean(black),
            p_white = mean(white),
            p_homeown = mean(homeown),
            p_household_head = mean(p_hh_head)) %>% 
  pivot_longer(cols = starts_with("p_"), names_to = "type",
               names_prefix = "p_", values_to = "prop")

## Calculate sample proportion (conservative)
matched_characteristics_conservative <- census_1940_hh_vars %>% 
  group_by(age, match_conservative) %>%
  summarize(p_hs = mean(hs),
            p_rural = mean(rural),
            p_black = mean(black),
            p_white = mean(white),
            p_homeown = mean(homeown),
            p_household_head = mean(p_hh_head)) %>% 
  pivot_longer(cols = starts_with("p_"), names_to = "type",
               names_prefix = "p_", values_to = "prop")

## Reshape data (standard)
matched_characteristics_standard <- matched_characteristics_standard %>% 
  mutate(type = as.factor(case_when(
    type == "hs" ~ "Educ: High School",
    type == "rural" ~ "Rural",
    type == "black" ~ "Race: Black",
    type == "white" ~ "Race: White",
    type == "household_head" ~ "Houshold Head",
    type == "homeown" ~ "Home Owner"
  ))) %>% 
  mutate(type = factor(type, levels=c('Educ: High School',
                                      'Race: Black','Race: White', 'Rural',
                                      "Houshold Head", "Home Owner")))


## Reshape data (conservative)
matched_characteristics_conservative <- matched_characteristics_conservative %>% 
  mutate(type = as.factor(case_when(
    type == "hs" ~ "Educ: High School",
    type == "rural" ~ "Rural",
    type == "black" ~ "Race: Black",
    type == "white" ~ "Race: White",
    type == "household_head" ~ "Houshold Head",
    type == "homeown" ~ "Home Owner"
  ))) %>% 
  mutate(type = factor(type, levels=c('Educ: High School',
                                      'Race: Black','Race: White', 'Rural',
                                      "Houshold Head", "Home Owner")))


## Plot data —— DMF representativeness (standard)
matched_characteristics_plot_standard <- matched_characteristics_standard %>% 
   ggplot(aes(x = age, y = prop, color = as.factor(match_standard))) + 
  geom_line(size = 1) + 
  theme_cowplot() + 
  ggsci::scale_color_lancet() + 
  xlim(20, 50) + 
  theme(legend.position = "bottom", legend.title = element_blank()) + 
  facet_wrap(~type) + 
    background_grid() 

## Plot data —— DMF representativeness (conservative)
matched_characteristics_plot_conservative <- matched_characteristics_conservative %>% 
   ggplot(aes(x = age, y = prop, color = as.factor(match_conservative))) + 
  geom_line(size = 1) + 
  theme_cowplot() + 
  ggsci::scale_color_lancet() + 
  xlim(20, 50) + 
  theme(legend.position = "bottom", legend.title = element_blank()) + 
  facet_wrap(~type) + 
  background_grid() 


## save plot 
ggsave(matched_characteristics_plot_standard, filename = here("vignettes/assess_match_quality/figs/dmf_matched_characteristics_plot_standard.pdf"), height = 7, width = 10)

## save plot 
ggsave(matched_characteristics_plot_conservative, filename = here("vignettes/assess_match_quality/figs/dmf_matched_characteristics_plot_conservative.pdf"), height = 7, width = 10)
```

## Sample Characteristics Table 

```{r}
## recode additional variables 
census_1940_hh_vars <- census_1940_hh_vars %>% 
  filter()



## 1940 census 
census_1940_characteristics <- census_1940_hh_vars %>% 
  filter(age %in% 15:40) %>% 
  summarize(p_educ_years = mean(educ_yrs, na.rm = T), p_black = mean(black), p_rural = mean(rural), p_homeowner = mean(homeown), p_highschool = mean(hs), p_household_head = mean(p_hh_head), p_white = mean(white), p_observations = n()) %>% 
pivot_longer(cols = starts_with("p_"), names_to = "type",
               names_prefix = "p_", values_to = "prop")

## matched census characteristics 
dmf_1940_characteristics_standard <- census_1940_hh_vars %>% 
  filter(age %in% 15:40) %>% 
  filter(match_standard == "Matched") %>%  
  summarize(p_educ_years = mean(educ_yrs, na.rm = T), p_black = mean(black), p_rural = mean(rural), p_homeowner = mean(homeown), p_highschool = mean(hs), p_household_head = mean(p_hh_head), p_white = mean(white), p_observations = n()) %>% 
pivot_longer(cols = starts_with("p_"), names_to = "type",
               names_prefix = "p_", values_to = "prop")

## matched census characteristics 
dmf_1940_characteristics_conservative <- census_1940_hh_vars %>% 
  filter(age %in% 15:40) %>% 
  filter(match_conservative == "Matched") %>%  
  summarize(p_educ_years = mean(educ_yrs, na.rm = T), p_black = mean(black), p_rural = mean(rural), p_homeowner = mean(homeown), p_highschool = mean(hs), p_household_head = mean(p_hh_head), p_white = mean(white), p_observations = n()) %>% 
pivot_longer(cols = starts_with("p_"), names_to = "type",
               names_prefix = "p_", values_to = "prop")

## inner join 
dmf_characteristics_table <- inner_join(census_1940_characteristics, dmf_1940_characteristics_standard, by = "type") %>%
  inner_join(dmf_1940_characteristics_conservative, by = "type") %>% 
  mutate(prop.x = round(prop.x, 3),
         prop.y = round(prop.y, 3),
         prop = round(prop, 3)) %>% 
  dplyr::select(type, Census = prop.x, CenSoc_DMF = prop.y, CenSoc_DMF_conservative = prop) %>% 
  gt() 

## print 
dmf_characteristics_table %>% 
  as_latex() %>%
  as.character() %>%
  cat()

## save table 
dmf_characteristics_table %>%
  gtsave("dmf_characteristics.tex", path = here("vignettes/assess_match_quality/figs/")) 
```


```{r}
## recode data  
 gen <- census_1940_hh_vars %>% 
  mutate(rural = case_when(
    rural == 1 ~ "Rural",
    TRUE ~ "Urban"
  ),
  homeown = case_when(
    homeown == 1 ~ "Home Owner",
    TRUE ~ "Not Home Owner"
  )) %>% 
  filter(age %in% 20:40) %>% 
  select(histid, race_recode, educ_level, sei_recode, marital_status, region_string, rural, homeown) %>%
  pivot_longer(-histid) %>% 
  group_by(name, value) %>%
  tally() %>%            
  mutate(prop = round(100*prop.table(n), 1)) %>% 
  rename(n_gen = n, prop_gen = prop)

censoc_dmf_1940_standard <- census_1940_hh_vars %>% 
  filter(link_abe_exact_standard == 1) %>% 
  mutate(rural = case_when(
    rural == 1 ~ "Rural",
    TRUE ~ "Urban"
  ),
  homeown = case_when(
    homeown == 1 ~ "Home Owner",
    TRUE ~ "Not Home Owner"
  )) %>% 
  filter(age %in% 20:40) %>% 
  select(histid, race_recode, educ_level, sei_recode, marital_status, region_string, rural, homeown) %>%
  pivot_longer(-histid) %>% 
  group_by(name, value) %>%
  tally() %>%            
  mutate(prop = round(100*prop.table(n), 1)) %>% 
  rename(n_gen_standard = n, prop_standard = prop)

censoc_dmf_1940_conservative <- census_1940_hh_vars %>% 
  filter(link_abe_exact_conservative == 1) %>% 
  mutate(rural = case_when(
    rural == 1 ~ "Rural",
    TRUE ~ "Urban"
  ),
  homeown = case_when(
    homeown == 1 ~ "Home Owner",
    TRUE ~ "Not Home Owner"
  )) %>% 
  filter(age %in% 20:40) %>% 
  select(histid, race_recode, educ_level, sei_recode, marital_status, region_string, rural, homeown) %>%
  pivot_longer(-histid) %>% 
  group_by(name, value) %>%
  tally() %>%            
  mutate(prop = round(100*prop.table(n), 1)) %>% 
  rename(n_gen_conservative = n, prop_conservative = prop)


unweighted_data <- gen %>% 
  inner_join(censoc_dmf_1940_standard, by = c("name", "value")) %>% 
  inner_join(censoc_dmf_1940_conservative, by = c("name", "value")) %>% 
 # mutate(name = as.factor(name), value = as.factor(name)) %>% 
  mutate(name = factor(name, levels = c("educ_level", "race_recode", "homeown", "sei_recode", "rural", "region_string", "Marital"))) %>% 
  # mutate(value = factor(value, levels = c('Male', 'Female',
  #                                     '18-29', '30-44', '45-59', '60+',
  #                                     '<HS Equivalent', "HS Equivalent", "Some college", "Bachelors", "Advanced degree",
  #                                     "White, non-Hispanic", "Black, non-Hispanic", "Other, non-Hispanic", "Hispanic", "2+, non-Hispanic", "Asian, non-Hispanic",
  #                                     "<$29,999", "$30,000 to $74,999", "$75,000 to $124,999", ">$125,000+",
  #                                     "Non-Metro Area", "Metro Area",
  #                                     "Married", "Widowed", "Divorced", "Separated", "Never married", "Living with partner"))) %>% 
  arrange(name, value) 

## create table 
table_s3 <- gt(data = unweighted_data) %>% 
  tab_spanner(
    label = "General Pop",
    columns = vars(
      n_gen, prop_gen)) %>% 
  tab_spanner(
    label = "Standard",
    columns = vars(
      n_gen_standard, prop_standard)) %>% 
  tab_spanner(
    label = "Conservative",
    columns = vars(
      n_gen_conservative, prop_conservative)) %>% 
  cols_label(
    "n_gen" = "No.",
    "prop_gen" = "%",
    "n_gen_standard" = "No.",
    "prop_standard" = "%",
    "n_gen_conservative"  = "No.",
    "prop_conservative" = "%",
    value = ""
  ) %>% 
  # row_group_order(
  #     groups = c("Gender", "Age", "Education", "Race")
  #   ) %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = cells_row_groups()
  ) %>% 
  opt_row_striping(row_striping = T) %>% 
  cols_align("left")


table_s3 %>%
  gtsave("dmf_characteristics_new.tex", path = here("vignettes/assess_match_quality/figs/")) 
```


```{r}
match_rate_characteristics <- census_1940_hh_vars %>% 
  mutate(rural = case_when(
    rural == 1 ~ "Rural",
    TRUE ~ "Urban"
  ),
  homeown = case_when(
    homeown == 1 ~ "Home Owner",
    TRUE ~ "Not Home Owner"
  )) %>% 
  filter(age %in% 20:40) %>% 
  select(histid, race_recode, educ_level, sei_recode, marital_status, region_string, rural, homeown) %>%
  pivot_longer(-c(histid, link_abe_exact_standard)) %>% 
  group_by(name, value) %>%
  summarize(mean(!is.na(link_abe_exact_standard)))
```


