---
title: "Make CenSoc Demo File"
author: "Benjamin Shapiro (shapiro_ben1729@berkeley.edu)"
date: "01-12-2023"
---

Summary: In this Notebook, I make the CenSoc-DMF and CenSoc-Numident Demo files. 

Steps to make CenSoc Demo File:

(1) Read in IPUMS 1940 1% Extract
(2) Link Crosswalk 
(2) Link to CenSoc-DMF 

Library the Packages for analysis 
```{r}
## library packages
library(tidyverse)
library(data.table)
library(ipumsr)
library(styler)
library(datasets)
library(readxl)
library(censocdev)
```
##Function to recode education
```{r}
recode_education <- function(df, educ_var) {

  df <- df  %>%
    mutate(educ_variable = !!sym(educ_var)) %>%
    mutate(educ_yrs = case_when(
      educ_variable == 2 ~ 0,
      educ_variable == 12 ~ 0,
      educ_variable == 14 ~ 1,
      educ_variable == 15 ~ 2,
      educ_variable == 16 ~ 3,
      educ_variable == 17 ~ 4,
      educ_variable == 22 ~ 5,
      educ_variable == 23 ~ 6,
      educ_variable == 25 ~ 7,
      educ_variable == 26 ~ 8,
      educ_variable == 30 ~ 9,
      educ_variable == 40 ~ 10,
      educ_variable == 50 ~ 11,
      educ_variable == 60 ~ 12,
      educ_variable == 70 ~ 13,
      educ_variable == 80 ~ 14,
      educ_variable == 90 ~ 15,
      educ_variable == 100 ~ 16,
      educ_variable == 110 ~ 17,
      educ_variable == 111 ~ 17,
      educ_variable == 112 ~ 17,
      educ_variable == 113 ~ 17
    )) %>%
    select(-educ_variable)

  return(df)

}

```
## Read in the 1 percent file and the crosswalk from IPUMS
```{r}
# Read in 1% IPUMS 1940 Census Extract
ipums1pct <- fread("/data/censoc/workspace/demo_input/sampleIPUMS.csv") %>% rename_all(tolower)

# Read crosswalk (Histid)
xwalk <- fread("/data/censoc/crosswalks/1940_histid_cc_1p_xwalk.txt")

# Join histid to ipums1pct
ipums1pct <- ipums1pct %>%
  inner_join(xwalk, by = c("serial", "pernum")) %>%
  relocate(histid)
```


## Construct Censoc-Numident Demo
```{r}
## Read in linked Numident 
numidentdata <- fread("/data/censoc/censoc_data_releases/censoc_numident/censoc_numident_v3/censoc_numident_v3.csv")

# Join numident to demo by histid
numidentdemo <- ipums1pct %>%
  rename(
    sex.demo = "sex",
    bpl.demo = "bpl"
  ) %>%
  inner_join(numidentdata, by = c("histid" = "HISTID")) # 93917 remaining observations

numidentdemo <- recode_education(numidentdemo,"educd")

# match sex, age and race from demo to numident data -- removed this code for V3 as there is no utility
#numident3.0 <- numidentdemo %>%
 # filter(
#    AGE == age, 
#    RACE == race,
#    SEX == sex.demo
#  ) # 85865 remaining observations

## Select numident variables for v3.0
vars_to_keep_num <- c("histid", "byear", "bmonth", "dyear", "dmonth", "death_age", "race_first", "race_first_cyear", "race_last", "bpl_string", "zip_residence", "socstate", "socstate_string", "age_first_application", "weight",  "perwt", "age", "sex", "bpl", "mbpl", "fbpl", "educd", "empstatd", "hispan", "incnonwg", "incwage", "marst", "nativity", "occ", "occscore",  "pernum", "race",  "serial")

## keep variables and rename to lower case 
demo_file_numident <- numidentdemo %>%
  select(vars_to_keep_num)
```

## Construct CenSoc-DMF Demo
```{r}
## Read in linked demo file 
dmfdata <- fread("/data/censoc/censoc_data_releases/censoc_dmf/censoc_dmf_v3/censoc_dmf_v3.csv")

# Join dmf to demo by histid
dmfdata_demo <- ipums1pct %>%
  inner_join(dmfdata, by = c("histid" = "HISTID")) # 76,496

# Match sex, age, and race from demo to dmf data -- removed this code for V3 as there is no utility
#dmf3.0 <- dmfdata_demo %>%
 # filter(
#    AGE == age,
 #   SEX == sex,
  #  RACE == race
#  ) # 70,211 remaining obs
dmfdata_demo <- recode_education(dmfdata_demo, "educd")
## Select DMF variables for v2.1
vars_to_keep_dmf <- c("histid", "byear", "bmonth", "dyear", "dmonth", "death_age", "weight", "perwt", "age", "sex", "bpld", "mbpl", "fbpl", "educd", "empstatd", "hispan", "incnonwg", "incwage", "marst", "nativity", "occ", "occscore",  "pernum", "race",  "serial")

## Write out demo file 
demo_file_dmf <- dmfdata_demo %>%
  select(vars_to_keep_dmf) 
```

statefip_string and bpl_string function
```{r}
# bpl_string_code<-read_csv("/data/josh/CenSoc/censoc_data/bpl_string_code.csv") %>%
#   mutate(Code= as.factor(Code))



demo_file_numident %>% 
  mutate(statefip = as.numeric(statefip)) %>% 
  count(statefip) %>% 
  add_row(statefip = c(2,15), n = c(0,0))


statefip_string_fun<-function(numident_dmf){
#Create separate data.frame for statefip values and add Alaska and Hawaii 
statenum<- numident_dmf %>% 
    mutate(statefip = as.numeric(statefip)) %>% 
    count(statefip) %>% 
    add_row(statefip= c(2,15), n = c(0,0)) %>% arrange(statefip)
  
#Create another data.frame with `state.name` character values and add Washington D.C.
state_new<-tibble(state.name) %>% 
  rbind("District of Columbia") %>% 
  arrange(state.name) %>% 
  mutate(statefip = statenum$statefip)

# Integrate state.name
return(numident_dmf %>% 
         inner_join(state_new, by = "statefip") %>% 
         # inner_join(bpl_string_code, by = c("bpl" = "Code")) %>% 
         rename(statefip_string = "state.name") %>% 
         mutate(statefip = as.factor(statefip),
                bpl = as.factor(bpl))) 
}


#Update numident and demo
demo_file_numident<-statefip_string_fun(demo_file_numident)
demo_file_dmf<-statefip_string_fun(demo_file_dmf)

## Write out csv file 
write_csv(demo_file_dmf, "/data/censoc/censoc_data_releases/censoc_dmf_demo/")
write_csv(demo_file_numident, "/data/censoc/censoc_data_releases/censoc_numdent_demo/")
```


