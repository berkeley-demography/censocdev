---
title: "Make CenSoc Demo File"
output: html_notebook
---

Summary: In this Notebook, I make the CenSoc-DMF Demo file. 

Steps to make CenSoc Demo File:

(1) Read in IPUMS 1940 1% Extract
(2) Link Crosswalk 
(2) Link to CenSoc-DMF 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Library the Packages for analysis 
```{r}
library(tidyverse)
library(dplyr)
library(data.table)
library(ipumsr)
```


```{r}
ipums1pct<-read_csv("sampleIPUMS.csv")
xwalk<-fread("/data/josh/CenSoc/crosswalks/1940_histid_cc_1p_xwalk.txt")

dmfdata<-read_csv("/data/josh/CenSoc/censoc_data/censoc_linked_to_census/v2.1/censoc_dmf_v2.1_linked.csv")
numidentdata<-read_csv("/data/josh/CenSoc/censoc_data/censoc_linked_to_census/v2.1/censoc_numident_v2.1_linked.csv")


dmfdata2<-read_csv("/data/josh/CenSoc/data_release_v2.1/dmf_v2.1/censoc_dmf_v2.1.csv")
numidentdata2<-read_csv("/data/josh/CenSoc/data_release_v2.1/numident_v2.1/censoc_numident_v2.1.csv")
```

```{r}
numidentdata<-numidentdata %>% 
  mutate(sexcheck = sex == SEX) %>% filter(sexcheck == T) #92 instances of unmatched sex

demo_file<-
  ipums1pct %>% 
  inner_join(xwalk, by = c("SERIAL" = "serial", "PERNUM" = "pernum")) %>% relocate(histid)
```
Demo to numident
```{r}
numidentdemo<-demo_file %>% 
  inner_join(numidentdata2, by = c("histid"="HISTID")) #93317 remaining observations

numidentdemo2<-numidentdemo %>% 
  mutate(sexcheck = sex == SEX) %>% filter(sexcheck == T) #lose 3479
numidentdata_demo<-numidentdemo2 %>% 
  inner_join(numidentdata, by = c("histid" = "HISTID", "YEAR"))
numident2.1<-
  numidentdata_demo %>% 
  filter(AGE.x == AGE.y,
         RACE.x == RACE.y) #85865 remaining observations
```
Demo to DMF
```{r}
dmfdemo<-demo_file %>% 
  inner_join(dmfdata2, by = c("histid"="HISTID")) #76,496

dmfdata_demo<-
  dmfdemo %>% 
  inner_join(dmfdata, by = c("histid" = "HISTID", "YEAR")) #.x is from the 1%
dmf2.1<-
  dmfdata_demo %>% 
  filter(AGE.x == AGE.y,
         SEX.x == SEX.y,
         RACE.x == RACE.y) #70,211 remaining obs

```

```{r}
vars_convert_to_labels <- c("SEX", "BPL", "MBPL", "FBPL", "EDUCD", "EMPSTATD", "HISPAN", "MARST", "NATIVITY", "OCC", "OWNERSHIP", "RACE", "STATEFIP", "URBAN", "INCNONWG")
newdata<-function(dataset){
  dataset %>% 
    select(HISTID = "histid",
         bmonth = "bmonth.x",
         byear = "byear.x",
         dmonth = "dmonth.x",
         dyear = "dyear.x",
         death_age = "death_age.x",
         weight = "weight.x",
         PERWT = "PERWT.x",
         AGE = "AGE.x",
         SEX = "SEX.x",
         BPL = "BPL.x",
         MBPL = "MBPL.x",
         FBPL = "FBPL.x",
         EDUCD = "EDUCD.x",
         EMPSTATD = "EMPSTATD.x",
         HISPAN = "HISPAN.x",
         INCNONWG = "INCNONWG.x",
         INCWAGE = "INCWAGE.x",
         MARST = "MARST.x",
         NATIVITY = "NATIVITY.x",
         OCC = "OCC.x",
         OCCSCORE = "OCCSCORE.x",
         OWNERSHIP = "OWNERSHP",
         PERNUM = "PERNUM.x",
         RACE = "RACE.x",
         RENT,STATEFIP,URBAN,
         SERIAL = "SERIAL.x") %>% 
  mutate_at(vars_convert_to_labels, as_factor) %>% 
  rename_all(tolower)
}

demo_file_numident<-newdata(numident2.1)
demo_file_dmf<-newdata(dmf2.1)

```

# Combine files to add ABE matching
```{r}
censoc_dmf_v2.1josh<-read_csv("/data/josh/CenSoc/data_release_v2.1/dmf_v2.1/censoc_dmf_v2.1.csv")
demo_file_dmf<-censoc_dmf_v2.1josh %>% inner_join(demo_file_dmf, by = c("HISTID" = "histid", "byear", "bmonth","dyear", "dmonth", "death_age", "weight"))

censoc_numident_v2.1josh <- read_csv("/data/josh/CenSoc/data_release_v2.1/numident_v2.1/censoc_numident_v2.1.csv") %>% 
  mutate(sex = as.factor(sex)) %>% select(-bpl)
demo_file_numidenta<-censoc_numident_v2.1josh %>% inner_join(demo_file_numident, by = c("HISTID" = "histid", "byear", "bmonth","dyear", "dmonth", "death_age", "weight", "sex"))



write_csv(demo_file_numidenta, "/censoc/data/censoc_files_for_website/censoc_numident_demo_v2.1.csv")
write_csv(demo_file_dmf, "/censoc/data/censoc_files_for_website/censoc_dmf_demo_v2.1.csv")
```


















