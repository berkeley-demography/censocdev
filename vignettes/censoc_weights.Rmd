---
title: "Create CenSoc Inverse-Proportional Weights"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Create CenSoc Inverse-Proportional Weights}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

## Read in CenSoc Samples

```{r}
library(data.table)
library(HMDHFDplus)
library(tidyverse)
```

## Read in CenSoc 
```{r}
censoc_male <- fread("/home/ipums/casey-ipums/censoc_files_for_website/censoc_id_date_v2.csv")
censoc_female_male <- fread("/home/ipums/casey-ipums/censoc_female_and_male_sample_matched_with_census.csv")
```

## Read in HMD Deaths
```{r}
hmd_deaths <-  readHMDweb(CNTRY = "USA", item = "Deaths_1x1", username ="caseybreen@berkeley.edu", password = "Bobbob12321") %>% mutate(linking_key = paste(Year, Age, sep = "_" ))
```

## Create CenSoc Male Sample Weights

- We will top code the age_at_death at 110 for the sample to facilitate matching to the HMD data, which is top-coded at 110.  

```{r}
censoc_male_deaths <- censoc_male %>%
  mutate(age_at_death = as.numeric(dyear - byear)) %>% 
  mutate(age_at_death = case_when(
    age_at_death > 110 ~ 110,
    age_at_death != 110 ~ age_at_death
  )) %>% 
  group_by(dyear, age_at_death) %>%
  tally() %>% 
  mutate(linking_key = paste(dyear, age_at_death, sep = "_")) %>% 
  ungroup(dyear, age_at_death)

censoc_male_weights <- censoc_male_deaths %>% 
inner_join(hmd_deaths, by = "linking_key") %>%
  mutate(proportion_matched = n/Male) %>% 
  mutate(perweight = 1/proportion_matched) %>% 
  select(linking_key, perweight)

censoc_male_sample_weighted <- censoc_male %>% 
  mutate(age_at_death = as.numeric(dyear - byear)) %>% 
  mutate(age_at_death = case_when(
    age_at_death > 110 ~ 110,
    age_at_death != 110 ~ age_at_death
  )) %>% 
  mutate(linking_key = paste(dyear, age_at_death, sep = "_")) %>% 
  left_join(censoc_male_weights) %>% 
  select(-linking_key, -age_at_death)
```


Histogram of the distribution of our weights for CenSoc Male Sample: 
```{r}
qplot(censoc_male_weights$perwt, geom = "histogram")
```
## Create CenSoc Female & Male Sample Weights

First, we should decide which years to include in the dataset. I decided it was best to only include 1988-2002. 
```{r}
## Create Linking Key for CenSoc Female & Male Sample
censoc_female_male_deaths <- censoc_female_male %>%
 mutate(age_at_death = as.numeric(dyear - byear)) %>% 
  mutate(age_at_death = case_when(
    age_at_death > 110 ~ 110,
    age_at_death != 110 ~ age_at_death
  )) %>% 
  group_by(dyear, age_at_death, SEX) %>%
  tally() %>% 
  mutate(linking_key = paste(dyear, age_at_death, sep = "_")) %>% 
  ungroup(dyear, age_at_death)

## Create Linking Key for CenSoc Female & Male Sample
censoc_female_weights_by_year <- censoc_female_male_deaths %>% 
inner_join(hmd_deaths, by = "linking_key") %>%
  mutate(proportion_matched = case_when(
    SEX == 1 ~ n/Male,
    SEX == 2 ~ n/Female)) %>% 
  group_by(dyear) %>% 
  summarize(year_prop_matched = mean(proportion_matched))

ggplot(data = censoc_female_weights_by_year) + 
  geom_line(aes(x = dyear,  y = year_prop_matched)) + 
  geom_vline(xintercept=1988)
```


```{r}
censoc_female_male_weights <- censoc_female_male_deaths %>% 
  inner_join(hmd_deaths, by = "linking_key") %>% 
  mutate(proportion_matched = case_when(
    SEX == 1 ~ n/Male,
    SEX == 2 ~ n/Female)) %>% 
  mutate(perweight = 1/proportion_matched) %>% 
  select(linking_key, perweight, SEX)

censoc_female_male_sample_weighted <- censoc_female_male %>% 
  filter(dyear >= 1988) %>% 
  mutate(age_at_death = as.numeric(dyear - byear)) %>% 
  mutate(age_at_death = case_when(
    age_at_death > 110 ~ 110,
    age_at_death != 110 ~ age_at_death
  )) %>% 
  mutate(linking_key = paste(dyear, age_at_death, sep = "_")) %>% 
  left_join(censoc_female_male_weights, by = c("linking_key", "SEX")) %>% 
  select(HISTID, byear, dyear, bmonth, dmonth, dstate, socstate, perweight)
```


Histogram of the distribution of our weights for CenSoc Female and Male Sample: 
```{r}
qplot(censoc_female_male_sample_weighted$perweight, geom = "histogram")
```

## Write out files: 
```{r}
write_csv(censoc_male_sample_weighted, "/home/ipums/casey-ipums/censoc_weighted_files/censoc_id_date_v2_weighted.csv")

write_csv(censoc_female_male_sample_weighted, "/home/ipums/casey-ipums/censoc_weighted_files/censoc_male_and_female_ss5_id_date_v0.1_weighted.csv")
```


